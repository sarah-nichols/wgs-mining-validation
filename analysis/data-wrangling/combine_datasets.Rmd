---
title: "conifer-output-formatting"
output: html_notebook
---

```{r setup, echo=FALSE}
# Knitr settings: 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
options(scipen = 999)
```

```{r, echo=FALSE}
source("./src/wgs-mining-validation-source.R")
```

```{r}
sample_info <- read.csv(file.path(data_path, "sample-info", "df-migrant-miseq.csv"))

asv_counts <- read.table(file.path(data_path, "metabarcoding", "ASVs_counts.tsv"))

df_wgs <- read_delim(file.path(data_path, "wgs-mining", "df_conifer_C70.csv"))

df_slides <- read_csv(file.path(data_path, "slides", "parasite_counts_slides.csv"))

df_metabarcoding_blast <- read.table(file.path(data_path, "metabarcoding", "basta_ncbi_full.tsv"))

df_metabarcoding_kraken <- read_csv(file.path(data_path, "metabarcoding", "df_conifer_metabarcoding_C70.csv"))

df_pcr <- read_csv(file.path(data_path, "pcr", "mock_pcr_results.csv"))

```

need to put all data in long format
```{r}
pcr_long <- pivot_longer(df_pcr, 
                          cols = c(Leucocytozoon, Haemoproteus, Plasmodium), 
                          names_to = "parasite_name", 
                          values_to = "infected") %>%
  mutate(method = "PCR")%>%
  drop_na() %>%
  select(parasite_name, ID, method)
  

```


```{r}
slides_long <- pivot_longer(df_slides, 
                          cols = c(Leucocytozoon, Haemoproteus, Plasmodium, Atoxoplasma), 
                          names_to = "parasite_name", 
                          values_to = "infected") %>%
  mutate(method = "Slides") %>%
  drop_na()%>%
  select(parasite_name, ID, method)

```


```{r}
df_metabarcoding_separated <- separate(df_metabarcoding_blast, V2, into = c("Kingdom", "Phylum", "Class", "Family", "Order", "Genus", "Species"), sep = ";")

parasite_genera_metabarcoding <- c("Theileria", "Babesia", "Isospora", "Blastocystis", "Eimeria")

asv_counts$ASV <- row.names(asv_counts)   
# Get the column names
original_colnames <- colnames(asv_counts)

# Use gsub to extract the part of the string that starts with 'B' and is followed by three digits
new_colnames <- gsub(".*(B\\d{3}).*", "\\1", original_colnames)

# Assign the new column names to the matrix
colnames(asv_counts) <- new_colnames

sample_ids <- sample_info %>%
  select(ID, sample_id_blood)

df_metabarcoding_long <- df_metabarcoding_separated %>%
dplyr::rename("ASV" = V1) %>%
dplyr::select(ASV, Genus) %>%
filter(Genus %in% parasite_genera_metabarcoding) %>%
left_join(asv_counts, by = "ASV") %>%
  pivot_longer(., 
              cols = starts_with("B"), 
              names_to = "sample_id_blood", 
              values_to = "count") %>%
  select(Genus, sample_id_blood, count) %>%
  dplyr::rename("parasite_name" = Genus) %>%
  filter(count > 0) %>%
  left_join(sample_ids, ., by = "sample_id_blood") %>%
  drop_na() %>%
  mutate(method = "Metabarcoding") %>%
  select(parasite_name, ID, method)

```

```{r}
df_metabarcoding_kraken_long <- df_metabarcoding_kraken %>%
  left_join(asv_counts, by = "ASV") %>%
  pivot_longer(., 
              cols = starts_with("B"), 
              names_to = "sample_id_blood", 
              values_to = "count") %>%
  select(parasite_name, sample_id_blood, count) %>%
  dplyr::filter(count > 0) %>%
  left_join(sample_ids, ., by = "sample_id_blood") %>%
  drop_na() %>%
  mutate(method = "Metabarcoding Kraken") %>%
  select(parasite_name, ID, method)

```


```{r}
wgs_long <- df_wgs %>%
  select(parasite_name, sample_id) %>%
  rename("sample_id" = "ID") %>%
  mutate(method = "WGS mining")
```

```{r}
full_data <- rbind(wgs_long, df_metabarcoding_long, df_metabarcoding_kraken_long, slides_long, pcr_long)
write_csv(full_data, file.path(data_path, "wrangled", "full_data.csv"))
```



